<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.hana_bank.mapper.LoanPaymentMapper">

    <!-- LoanPayment 결과 맵 -->
    <resultMap id="LoanPaymentResultMap" type="com.example.hana_bank.entity.LoanPayment">
        <id property="paymentId" column="payment_id"/>
        <result property="transactionId" column="transaction_id"/>
        <result property="contractNumber" column="contract_number"/>
        <result property="paymentAmount" column="payment_amount"/>
        <result property="landlordAccount" column="landlord_account"/>
        <result property="landlordName" column="landlord_name"/>
        <result property="status" column="status"/>
        <result property="executionType" column="execution_type"/>
        <result property="scheduledAt" column="scheduled_at"/>
        <result property="executedAt" column="executed_at"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="remarks" column="remarks"/>
    </resultMap>

    <!-- 대출 지급 정보 삽입 -->
    <insert id="insertLoanPayment" parameterType="com.example.hana_bank.entity.LoanPayment">
        <selectKey keyProperty="paymentId" resultType="Long" order="BEFORE">
            SELECT LOAN_PAYMENT_SEQ.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO LOAN_PAYMENTS (
            PAYMENT_ID, TRANSACTION_ID, CONTRACT_NUMBER, PAYMENT_AMOUNT,
            LANDLORD_ACCOUNT, LANDLORD_NAME, STATUS, EXECUTION_TYPE,
            SCHEDULED_AT, EXECUTED_AT, CREATED_AT, UPDATED_AT, REMARKS
        ) VALUES (
            #{paymentId}, #{transactionId}, #{contractNumber}, #{paymentAmount},
            #{landlordAccount}, #{landlordName}, #{status}, #{executionType},
            #{scheduledAt}, #{executedAt}, SYSDATE, SYSDATE, #{remarks}
        )
    </insert>

    <!-- 모든 대출 지급 조회 -->
    <select id="findAllLoanPayments" resultMap="LoanPaymentResultMap">
        SELECT * FROM loan_payments 
        ORDER BY created_at DESC
    </select>

    <!-- 거래ID로 대출 지급 조회 -->
    <select id="findByTransactionId" parameterType="String" resultMap="LoanPaymentResultMap">
        SELECT * FROM loan_payments 
        WHERE transaction_id = #{transactionId}
    </select>

    <!-- 계약번호로 대출 지급 조회 -->
    <select id="findByContractNumber" parameterType="String" resultMap="LoanPaymentResultMap">
        SELECT * FROM loan_payments 
        WHERE contract_number = #{contractNumber}
    </select>

    <!-- 지급 상태 업데이트 -->
    <update id="updatePaymentStatus">
        UPDATE loan_payments 
        SET status = #{status}, updated_at = SYSDATE 
        WHERE payment_id = #{paymentId}
    </update>

    <!-- 상태별 대출 지급 조회 -->
    <select id="findByStatus" parameterType="String" resultMap="LoanPaymentResultMap">
        SELECT * FROM loan_payments 
        WHERE status = #{status}
        ORDER BY created_at DESC
    </select>

    <!-- 예약일별 대출 지급 조회 -->
    <select id="findByScheduledDate" parameterType="String" resultMap="LoanPaymentResultMap">
        SELECT * FROM loan_payments 
        WHERE DATE(scheduled_at) = #{scheduledDate}
        ORDER BY scheduled_at
    </select>

</mapper>