<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.living.hana.mapper.LinkedSecuritiesAccountMapper">
    
    <insert id="insertLinkedAccount" parameterType="com.living.hana.entity.LinkedSecuritiesAccount">
        <selectKey keyProperty="id" resultType="long" order="BEFORE">
            SELECT LINKED_SECURITIES_ACCOUNT_SEQ.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO LINKED_SECURITIES_ACCOUNTS (
            ID, USER_ID, USER_CI, ACCOUNT_NUMBER, ACCOUNT_NAME, 
            ACCOUNT_TYPE, STATUS, LINK_TOKEN, CREATED_AT, UPDATED_AT
        ) VALUES (
            #{id}, #{userId}, #{userCi}, #{accountNumber}, #{accountName}, 
            #{accountType}, #{status}, #{linkToken}, SYSDATE, SYSDATE
        )
    </insert>
    
    <select id="findAccountsByUserId" resultType="com.living.hana.entity.LinkedSecuritiesAccount">
        SELECT 
            ID, USER_ID, USER_CI, ACCOUNT_NUMBER, ACCOUNT_NAME, 
            ACCOUNT_TYPE, STATUS, LINK_TOKEN, 
            TO_CHAR(CREATED_AT, 'YYYY-MM-DD HH24:MI:SS') AS CREATED_AT,
            TO_CHAR(UPDATED_AT, 'YYYY-MM-DD HH24:MI:SS') AS UPDATED_AT
        FROM LINKED_SECURITIES_ACCOUNTS 
        WHERE USER_ID = #{userId} 
        AND STATUS = 'ACTIVE'
        ORDER BY CREATED_AT DESC
    </select>
    
    <select id="findAccountsByUserCi" resultType="com.living.hana.entity.LinkedSecuritiesAccount">
        SELECT 
            ID, USER_ID, USER_CI, ACCOUNT_NUMBER, ACCOUNT_NAME, 
            ACCOUNT_TYPE, STATUS, LINK_TOKEN, 
            TO_CHAR(CREATED_AT, 'YYYY-MM-DD HH24:MI:SS') AS CREATED_AT,
            TO_CHAR(UPDATED_AT, 'YYYY-MM-DD HH24:MI:SS') AS UPDATED_AT
        FROM LINKED_SECURITIES_ACCOUNTS 
        WHERE USER_CI = #{userCi} 
        AND STATUS = 'ACTIVE'
        ORDER BY CREATED_AT DESC
    </select>
    
    <select id="findAccountByUserIdAndAccountNumber" resultType="com.living.hana.entity.LinkedSecuritiesAccount">
        SELECT 
            ID, USER_ID, USER_CI, ACCOUNT_NUMBER, ACCOUNT_NAME, 
            ACCOUNT_TYPE, STATUS, LINK_TOKEN, 
            TO_CHAR(CREATED_AT, 'YYYY-MM-DD HH24:MI:SS') AS CREATED_AT,
            TO_CHAR(UPDATED_AT, 'YYYY-MM-DD HH24:MI:SS') AS UPDATED_AT
        FROM LINKED_SECURITIES_ACCOUNTS 
        WHERE USER_ID = #{userId} 
        AND ACCOUNT_NUMBER = #{accountNumber}
    </select>
    
    <update id="updateAccountStatus">
        UPDATE LINKED_SECURITIES_ACCOUNTS 
        SET STATUS = #{status}, UPDATED_AT = SYSDATE 
        WHERE ID = #{id}
    </update>
    
    <delete id="deleteLinkedAccount">
        DELETE FROM LINKED_SECURITIES_ACCOUNTS 
        WHERE ID = #{id}
    </delete>
    
    <select id="existsByUserIdAndAccountNumber" resultType="boolean">
        SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END
        FROM LINKED_SECURITIES_ACCOUNTS 
        WHERE USER_ID = #{userId} 
        AND ACCOUNT_NUMBER = #{accountNumber}
        AND STATUS = 'ACTIVE'
    </select>
    
</mapper>